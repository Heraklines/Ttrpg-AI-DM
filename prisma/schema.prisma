generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Campaign {
  id              String        @id @default(uuid())
  name            String
  description     String?
  adventureModule String?       // JSON stored as string for SQLite
  settings        String?       // JSON stored as string for SQLite
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  characters      Character[]
  gameState       GameState?
  sessions        Session[]
  lore            CampaignLore?
  worldSeed       WorldSeed?
  generationLogs  LoreGenerationLog[]
  quizSessions    QuizSession[]
}

model Character {
  id                       String   @id @default(uuid())
  campaignId               String?
  campaign                 Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  name                     String
  race                     String
  className                String
  subclass                 String?
  level                    Int      @default(1)
  background               String?
  alignment                String?
  strength                 Int      @default(10)
  dexterity                Int      @default(10)
  constitution             Int      @default(10)
  intelligence             Int      @default(10)
  wisdom                   Int      @default(10)
  charisma                 Int      @default(10)
  maxHp                    Int
  currentHp                Int
  tempHp                   Int      @default(0)
  armorClass               Int      @default(10)
  speed                    Int      @default(30)
  hitDiceType              Int      @default(8)
  hitDiceRemaining         Int      @default(1)
  deathSaveSuccesses       Int      @default(0)
  deathSaveFailures        Int      @default(0)
  savingThrowProficiencies String   @default("[]")
  skillProficiencies       String   @default("[]")
  skillExpertise           String   @default("[]")
  spellSlots               String   @default("{}")
  knownSpells              String   @default("[]")
  preparedSpells           String   @default("[]")
  spellcastingAbility      String?
  classResources           String   @default("[]")
  inventory                String   @default("[]")
  equippedItems            String   @default("{}")
  gold                     Int      @default(0)
  conditions               String   @default("[]")
  features                 String   @default("[]")
  backstory                String?
  notes                    String?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@index([campaignId])
}

model GameState {
  id                String   @id @default(uuid())
  campaignId        String   @unique
  campaign          Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  mode              String   @default("exploration")
  currentLocationId String?
  exploredLocations String   @default("[]")
  gameDay           Int      @default(1)
  gameHour          Int      @default(8)
  gameMinute        Int      @default(0)
  activeCombat      String?  // JSON stored as string
  activeMap         String?  // JSON stored as string - GameMap object
  entityPositions   String   @default("{}") // JSON - Record<entityId, {x, y}>
  flags             String   @default("{}")
  activeQuests      String   @default("[]")
  completedQuests   String   @default("[]")
  knownNpcs         String   @default("[]")
  recentMessages    String   @default("[]")
  updatedAt         DateTime @updatedAt
}

model Location {
  id                 String   @id @default(uuid())
  campaignId         String
  name               String
  description        String?
  locationType       String   @default("other") // dungeon, town, wilderness, building, cave
  mapData            String?  // JSON stored as string - GameMap object
  connectedLocations String   @default("[]") // JSON - Array of {locationId, direction, description}
  npcsPresent        String   @default("[]")
  isExplored         Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([campaignId])
}

model Session {
  id            String    @id @default(uuid())
  campaignId    String
  campaign      Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  sessionNumber Int
  startedAt     DateTime  @default(now())
  endedAt       DateTime?
  transcript    String    @default("[]")
  summary       String?
  stateSnapshot String?   // JSON stored as string

  @@index([campaignId])
}

model UserSettings {
  id            String   @id @default(uuid())
  geminiApiKey  String?
  theme         String   @default("dark")
  fontSize      String   @default("medium")
  diceAnimation Boolean  @default(true)
  soundEnabled  Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model MonsterCache {
  id        String   @id
  name      String
  data      String   // JSON stored as string
  fetchedAt DateTime @default(now())

  @@index([name])
}

model SpellCache {
  id        String   @id
  name      String
  data      String   // JSON stored as string
  fetchedAt DateTime @default(now())

  @@index([name])
}

model CampaignTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================================
// WORLD SEED SYSTEM - Tension-First Generation
// ============================================================

model WorldSeed {
  id              String   @id @default(uuid())
  campaignId      String   @unique
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  name            String?
  tone            String   @default("heroic")
  scale           String   @default("regional")
  themes          String   @default("[]")
  
  coreTensions    String   @default("[]")
  creationMyth    String?
  
  generationStatus String  @default("pending")
  currentPhase    String?
  generationError String?
  
  geography       WorldGeography?
  cosmology       WorldCosmology?
  history         WorldHistory?
  factions        WorldFaction[]
  locations       WorldLocation[]
  npcs            WorldNpc[]
  conflicts       WorldConflict[]
  secrets         WorldSecret[]
  relationships   WorldRelationship[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model WorldGeography {
  id              String    @id @default(uuid())
  worldSeedId     String    @unique
  worldSeed       WorldSeed @relation(fields: [worldSeedId], references: [id], onDelete: Cascade)
  
  heightmapSeed   Int       @default(0)
  mapSettings     String    @default("{}")
  mapData         String?
  svgCache        String?
  
  continents      String    @default("[]")
  oceans          String    @default("[]")
  majorRegions    String    @default("[]")
  
  naturalLaws     String    @default("{}")
  magicGeography  String    @default("[]")
  
  updatedAt       DateTime  @updatedAt
}

model WorldCosmology {
  id              String    @id @default(uuid())
  worldSeedId     String    @unique
  worldSeed       WorldSeed @relation(fields: [worldSeedId], references: [id], onDelete: Cascade)
  
  planarStructure String    @default("{}")
  magicSystem     String    @default("{}")
  
  pantheon        String    @default("[]")
  
  creationStory   String?
  prophecies      String    @default("[]")
  afterlife       String    @default("{}")
  
  updatedAt       DateTime  @updatedAt
}

model WorldHistory {
  id              String    @id @default(uuid())
  worldSeedId     String    @unique
  worldSeed       WorldSeed @relation(fields: [worldSeedId], references: [id], onDelete: Cascade)
  
  eras            String    @default("[]")
  majorEvents     String    @default("[]")
  
  writtenBy       String    @default("[]")
  lostKnowledge   String    @default("[]")
  
  updatedAt       DateTime  @updatedAt
}

model WorldFaction {
  id              String    @id @default(uuid())
  worldSeedId     String
  worldSeed       WorldSeed @relation(fields: [worldSeedId], references: [id], onDelete: Cascade)
  
  tier            String    @default("supporting")
  
  name            String
  type            String
  philosophy      String?
  
  tensionStances  String    @default("[]")
  
  leadership      String    @default("{}")
  ranks           String    @default("[]")
  membership      String    @default("{}")
  
  resources       String    @default("[]")
  territory       String    @default("[]")
  factionSecrets  String    @default("[]")
  
  publicImage     String?
  symbol          String?
  motto           String?
  influence       Int       @default(5)
  
  isDiscovered    Boolean   @default(false)
  discoveredAt    DateTime?
  
  members         WorldNpc[]
  
  @@index([worldSeedId])
  @@index([tier])
}

model WorldNpc {
  id              String    @id @default(uuid())
  worldSeedId     String
  worldSeed       WorldSeed @relation(fields: [worldSeedId], references: [id], onDelete: Cascade)
  
  tier            String    @default("minor")
  
  name            String
  race            String?
  occupation      String?
  age             String?
  appearance      String?
  
  personality     String    @default("{}")
  speakingStyle   String?
  mannerisms      String    @default("[]")
  
  publicGoal      String?
  privateGoal     String?
  fears           String    @default("[]")
  tensionRole     String    @default("[]")
  
  factionId       String?
  faction         WorldFaction? @relation(fields: [factionId], references: [id])
  factionRank     String?
  primaryLocationId String?
  
  knowledgeScope  String    @default("{}")
  defaultAttitude String    @default("neutral")
  
  npcSecrets      String    @default("[]")
  hiddenIdentity  String?
  
  isDiscovered    Boolean   @default(false)
  discoveredAt    DateTime?
  relationshipLevel String  @default("unknown")
  
  @@index([worldSeedId])
  @@index([factionId])
  @@index([tier])
}

model WorldLocation {
  id              String    @id @default(uuid())
  worldSeedId     String
  worldSeed       WorldSeed @relation(fields: [worldSeedId], references: [id], onDelete: Cascade)
  
  tier            String    @default("minor")
  type            String
  
  parentId        String?
  parent          WorldLocation? @relation("LocationHierarchy", fields: [parentId], references: [id])
  children        WorldLocation[] @relation("LocationHierarchy")
  
  mapCoordinates  String    @default("{}")
  terrain         String?
  climate         String?
  size            String?
  
  name            String
  description     String?
  atmosphere      String?
  sensoryDetails  String    @default("{}")
  
  controllingFactionId String?
  contestedBy     String    @default("[]")
  population      String    @default("{}")
  economy         String    @default("{}")
  
  landmarks       String    @default("[]")
  currentEvents   String    @default("[]")
  rumors          String    @default("[]")
  locationSecrets String    @default("[]")
  
  isDiscovered    Boolean   @default(false)
  discoveredAt    DateTime?
  explorationLevel String   @default("unknown")
  
  @@index([worldSeedId])
  @@index([parentId])
  @@index([type])
}

model WorldConflict {
  id              String    @id @default(uuid())
  worldSeedId     String
  worldSeed       WorldSeed @relation(fields: [worldSeedId], references: [id], onDelete: Cascade)
  
  tier            String    @default("supporting")
  
  name            String
  type            String
  scope           String    @default("regional")
  status          String    @default("brewing")
  
  rootTension     String?
  triggerEvent    String?
  
  sides           String    @default("[]")
  neutrals        String    @default("[]")
  
  stakes          String?
  publicNarrative String?
  trueNature      String?
  
  timeline        String    @default("[]")
  currentState    String?
  possibleOutcomes String   @default("[]")
  
  playerInfluence String    @default("[]")
  
  affectedLocationIds String @default("[]")
  
  isDiscovered    Boolean   @default(false)
  discoveredAt    DateTime?
  knowledgeLevel  String    @default("unaware")
  
  @@index([worldSeedId])
  @@index([status])
}

model WorldSecret {
  id              String    @id @default(uuid())
  worldSeedId     String
  worldSeed       WorldSeed @relation(fields: [worldSeedId], references: [id], onDelete: Cascade)
  
  tier            String    @default("supporting")
  type            String
  
  name            String
  content         String
  implications    String?
  
  tensionImpact   String    @default("[]")
  
  knownBy         String    @default("[]")
  suspectedBy     String    @default("[]")
  
  hints           String    @default("[]")
  discoveryConditions String @default("[]")
  revealTriggers  String    @default("[]")
  
  onReveal        String    @default("{}")
  
  isRevealed      Boolean   @default(false)
  partialReveals  String    @default("[]")
  revealedAt      DateTime?
  
  @@index([worldSeedId])
  @@index([isRevealed])
}

model WorldRelationship {
  id              String    @id @default(uuid())
  worldSeedId     String
  worldSeed       WorldSeed @relation(fields: [worldSeedId], references: [id], onDelete: Cascade)
  
  sourceType      String
  sourceId        String
  targetType      String
  targetId        String
  
  type            String
  strength        Int       @default(5)
  isPublic        Boolean   @default(true)
  
  description     String?
  history         String?
  instability     String?
  
  isDiscovered    Boolean   @default(false)
  discoveredAt    DateTime?
  
  @@index([worldSeedId])
  @@index([sourceType, sourceId])
  @@index([targetType, targetId])
}

// ============================================================
// CAMPAIGN LORE GENERATION SYSTEM (Legacy - kept for compatibility)
// ============================================================

model CampaignLore {
  id                String   @id @default(uuid())
  campaignId        String   @unique
  campaign          Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  // Generation status tracking
  generationStatus  String   @default("pending") // pending, generating, completed, failed
  generationPhase   String?  // current phase being generated
  generationError   String?  // error message if failed
  startedAt         DateTime?
  completedAt       DateTime?
  
  // Core lore content (JSON stored as strings for SQLite)
  worldName         String?
  tone              String?  // dark, heroic, comedic, intrigue, epic, gritty, mysterious
  themes            String   @default("[]")
  cosmology         String   @default("{}")
  worldHistory      String   @default("[]")
  
  // Relational data
  npcs              LoreNpc[]
  factions          LoreFaction[]
  locations         LoreLocation[]
  conflicts         LoreConflict[]
  secrets           LoreSecret[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([generationStatus])
}

model LoreNpc {
  id              String       @id @default(uuid())
  campaignLoreId  String
  campaignLore    CampaignLore @relation(fields: [campaignLoreId], references: [id], onDelete: Cascade)
  
  name            String
  role            String
  importance      String       @default("minor")
  tier            String       @default("minor")
  
  personality     String       @default("{}")
  speakingStyle   String?
  quirks          String       @default("[]")
  
  publicGoal      String?
  secretGoal      String?
  fears           String       @default("[]")
  tensionStances  String       @default("[]")
  tensionRole     String       @default("[]")
  
  relationships   String       @default("[]")
  factionId       String?
  
  primaryLocation String?
  
  race            String?
  appearance      String?
  
  isRevealed      Boolean      @default(false)
  isDiscovered    Boolean      @default(false)
  discoveredAt    DateTime?
  playerRelation  String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([campaignLoreId])
  @@index([importance])
  @@index([role])
  @@index([tier])
}

model LoreFaction {
  id              String       @id @default(uuid())
  campaignLoreId  String
  campaignLore    CampaignLore @relation(fields: [campaignLoreId], references: [id], onDelete: Cascade)
  
  name            String
  type            String
  importance      String       @default("minor")
  tier            String       @default("supporting")
  
  publicImage     String?
  secretNature    String?
  symbol          String?
  motto           String?
  philosophy      String?
  
  tensionStances  String       @default("[]")
  
  goals           String       @default("[]")
  methods         String       @default("[]")
  resources       String       @default("[]")
  
  allies          String       @default("[]")
  enemies         String       @default("[]")
  
  headquarters    String?
  territory       String       @default("[]")
  influence       Int          @default(5)
  
  playerStanding  String?
  isDiscovered    Boolean      @default(false)
  discoveredAt    DateTime?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([campaignLoreId])
  @@index([type])
  @@index([tier])
}

model LoreLocation {
  id              String       @id @default(uuid())
  campaignLoreId  String
  campaignLore    CampaignLore @relation(fields: [campaignLoreId], references: [id], onDelete: Cascade)
  
  name            String
  locationType    String
  importance      String       @default("minor")
  tier            String       @default("minor")
  
  parentId        String?
  parent          LoreLocation? @relation("LoreLocationHierarchy", fields: [parentId], references: [id])
  children        LoreLocation[] @relation("LoreLocationHierarchy")
  
  mapCoordinates  String       @default("{}")
  
  description     String?
  atmosphere      String?
  sensoryDetails  String       @default("{}")
  
  region          String?
  terrain         String?
  climate         String?
  connectedTo     String       @default("[]")
  
  historicalNote  String?
  currentEvents   String       @default("[]")
  
  population      String?
  notableNpcs     String       @default("[]")
  factionPresence String       @default("[]")
  
  hiddenSecrets   String       @default("[]")
  
  isDiscovered    Boolean      @default(false)
  discoveredAt    DateTime?
  explorationLevel String      @default("unknown")
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([campaignLoreId])
  @@index([locationType])
  @@index([region])
  @@index([parentId])
  @@index([tier])
}

model LoreConflict {
  id              String       @id @default(uuid())
  campaignLoreId  String
  campaignLore    CampaignLore @relation(fields: [campaignLoreId], references: [id], onDelete: Cascade)
  
  name            String
  type            String
  scope           String       @default("regional")
  importance      String       @default("supporting")
  tier            String       @default("supporting")
  
  rootTension     String?
  
  participants    String       @default("[]")
  
  stakes          String?
  publicKnowledge String?
  trueNature      String?
  
  currentState    String       @default("brewing")
  recentEvents    String       @default("[]")
  
  possibleOutcomes String      @default("[]")
  playerInfluence  String?
  
  isRevealed      Boolean      @default(false)
  isDiscovered    Boolean      @default(false)
  discoveredAt    DateTime?
  playerStance    String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([campaignLoreId])
  @@index([type])
  @@index([currentState])
  @@index([tier])
}

model LoreSecret {
  id              String       @id @default(uuid())
  campaignLoreId  String
  campaignLore    CampaignLore @relation(fields: [campaignLoreId], references: [id], onDelete: Cascade)
  
  name            String
  type            String
  importance      String       @default("supporting")
  tier            String       @default("supporting")
  
  content         String
  implications    String?
  hints           String       @default("[]")
  
  tensionImpact   String       @default("[]")
  
  relatedNpcs     String       @default("[]")
  relatedFactions String       @default("[]")
  relatedLocations String      @default("[]")
  
  discoveryConditions String   @default("[]")
  revealImpact    String?
  
  isRevealed      Boolean      @default(false)
  isDiscovered    Boolean      @default(false)
  discoveredAt    DateTime?
  partiallyKnown  String       @default("[]")
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([campaignLoreId])
  @@index([type])
  @@index([isRevealed])
  @@index([tier])
}

// ============================================================
// LORE GENERATION DEBUG LOG
// ============================================================

model LoreGenerationLog {
  id          String   @id @default(uuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  phase       String   // tensions, cosmology, factions, npcs, conflicts, locations, secrets, coherence
  status      String   @default("started") // started, completed, failed

  prompt      String?  // The prompt sent to AI (can be large)
  response    String?  // The AI response (can be large)
  parsedData  String?  // The extracted JSON data

  error       String?  // Error message if failed

  tokenCount  Int?     // Approximate token count
  durationMs  Int?     // How long the phase took

  createdAt   DateTime @default(now())

  @@index([campaignId])
  @@index([phase])
  @@index([createdAt])
}

// ============================================================
// SOUL MIRROR QUIZ SYSTEM
// Personality-driven D&D character generator
// ============================================================

model QuizQuestion {
  id          String   @id @default(uuid())
  text        String
  category    String   // fantasy_scenario, real_life, dnd_hypothetical
  dimension   String   // O, C, E, A, N (primary Big Five dimension tested)
  answers     String   // JSON: [{text, scores: {O?, C?, E?, A?, N?}, classHints?, raceHints?}]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  @@index([category])
  @@index([dimension])
}

model QuizSession {
  id               String      @id @default(uuid())
  campaignId       String
  campaign         Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  // Quiz state
  usedQuestionIds  String      @default("[]")  // JSON array of question IDs
  currentIndex     Int         @default(0)
  totalQuestions   Int         @default(15)
  
  // Running Big Five scores (0-100, start at 50)
  scoreO           Int         @default(50)  // Openness
  scoreC           Int         @default(50)  // Conscientiousness
  scoreE           Int         @default(50)  // Extraversion
  scoreA           Int         @default(50)  // Agreeableness
  scoreN           Int         @default(50)  // Neuroticism
  
  status           String      @default("in_progress")  // in_progress, completed, abandoned
  completedAt      DateTime?
  
  result           QuizResult?
  
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  
  @@index([campaignId])
  @@index([status])
}

model QuizResult {
  id                  String      @id @default(uuid())
  sessionId           String      @unique
  session             QuizSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Final Big Five scores (0-100)
  openness            Int
  conscientiousness   Int
  extraversion        Int
  agreeableness       Int
  neuroticism         Int
  
  // Derived D&D attributes
  alignment           String      // e.g., "Chaotic Good"
  suggestedRace       String
  suggestedClass      String
  suggestedBackground String
  
  // AI-generated content
  backstory           String?
  personalityTraits   String      @default("[]")  // JSON: ["trait1", "trait2"]
  ideal               String?
  bond                String?
  flaw                String?
  
  // Suggested ability scores (JSON for point-buy suggestion)
  suggestedAbilities  String      @default("{\"strength\":10,\"dexterity\":10,\"constitution\":10,\"intelligence\":10,\"wisdom\":10,\"charisma\":10}")
  
  // Share functionality
  shareToken          String?     @unique  // For shareable URL
  shareImageUrl       String?     // Rendered share card image path
  
  createdAt           DateTime    @default(now())
  
  @@index([shareToken])
}

